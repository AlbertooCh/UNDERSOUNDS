{% extends 'base.html' %}
{% load static %}
{% block title %}Cancion - Undersounds{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'music/css/music.css' %}">
{% endblock %}
{% block content %}

<body>
    <main>
        <div id="overlay" class="overlay">
        <div class="info-box">
             <h2>Información</h2>
            <p id="info-text">Este es un cuadro de información.</p>
            <button onclick="window.location.href='../login/'; hideInfoBox();">Sin Usuario</button>
            <button onclick="">Con Usuario</button>
            <button onclick="hideInfoBox()">Cerrar</button>
        </div>
        </div>
        <div id="overlayDesc" class="overlay">
        <div class="info-box">
            <h2>Información</h2>
            <p id="info-text">Este es un cuadro de información.</p>
            <a href="../static/MP3.txt" download="MP3.txt">
                <button>MP3</button>
            </a>
            <a href="../static/FLAC.txt" download="FLAC.txt">
                <button>FLAC</button>
            </a>
            <a href="../static/WAV.txt" download="WAV.txt">
                <button>WAV</button>
            </a>
            <button onclick="hideInfoBoxD()">Cerrar</button>
        </div>
        </div>
        <div id="overlayComent" class="overlay">
        <div class="info-box">
            <h2>Información</h2>
            <p id="info-text">Este es un cuadro de información.</p>
            <button onclick="window.location.href='../login/'; hideInfoBoxC();">Sin Usuario</button>
            <button onclick="addComment()">Con Usuario</button>
            <button onclick="hideInfoBoxC()">Cerrar</button>
        </div>
        </div>
        <button class="back-button" onclick="goBack()"><-</button>
        <div class="track-info" id = "track-info">
            <div class="track-details">
                <h1 id="song-name"></h1>
                <p id="artist-name"></p>
                <button id="play-button" onclick="showInfoBox()" >Play</button>
                <button id="Desc-button" onclick="showInfoBoxD()" >Descargar</button>
                <button id="like" >Like ♡ ❤</button>
            </div>
            <img id="track-cover" class="track-cover" alt="Track Cover">
        </div>
        <button id="Descripcion">Descripcion</button>
        <div id="Desc" class="Desc">
            <p>Descripcion de la cancion</p>
        </div>
        <div class="comments-section">
            <div class="comments">
                <h2>Comments</h2>
                <div id="comments-anadir">
                   <input type="text" id="new-comment" placeholder="Añadir un comentario..." class="new-comment"></input>
                    <div class="star-rating">
        <input type="radio" id="star5" name="rating" value="5"><label for="star5">★</label>
        <input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label>
        <input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label>
        <input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label>
        <input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label>
    </div>
                <button onclick="showInfoBoxC()">Enviar</button>
                </div>
                <div id="comentarios"></div>

            </div>
            <div class="author-info">
                <h2>Author Information</h2>
                <button id="edit-button" onclick="window.location.href='../artist_detail/';" >Seguir</button>
                <img id="author-image" class="author-images" alt="../static/Photos/OIP.jpg" >
                <p><strong>Name:</strong> <span id="author-name"></span></p>
                <p><strong>Genre:</strong> <span id="author-genre"></span></p>
                <h2>Canciones del mismo album</h2>
                <div id="song-list"></div>
            </div>
        </div>
    </main>
    <script>


        function goBack() {
            window.history.back();
        }

        function showInfoBox() {
            document.getElementById('overlay').classList.add('active');
        }

        function hideInfoBox() {
            document.getElementById('overlay').classList.remove('active');
        }

        function showInfoBoxD() {
            document.getElementById('overlayDesc').classList.add('active');
        }

        function hideInfoBoxD() {
            document.getElementById('overlayDesc').classList.remove('active');
        }

        function showInfoBoxC() {
            document.getElementById('overlayComent').classList.add('active');
        }

        function hideInfoBoxC() {
            document.getElementById('overlayComent').classList.remove('active');
        }

        const item = JSON.parse(localStorage.getItem('item'));


        if (item) {
            document.getElementById('song-name').textContent = item.song_name;
            document.getElementById('artist-name').textContent = `by ${item.artist_name}`;
            document.getElementById('track-cover').src = item.album_photo;
            document.getElementById('author-name').textContent = item.artist_name;
            document.getElementById('author-genre').textContent = item.genre;
            document.getElementById('author-image').src = item.artist_photo;
            mostrarComentarios();

            const trackList = document.getElementById('track-list');
            mostrarComentarios();
        } else {
            document.querySelector('.track-info').innerHTML = '<p>No hay datos disponibles.</p>';
        }


        let canciones = [];
        fetch('/static/prueba5.json')
            .then(response => response.json())
            .then(data => {
                canciones = data;
                filterCanciones();
            })
        .catch(error => console.error('Error al cargar el JSON:', error));

        function filterCanciones() {
            fetch('/static/prueba5.json')
                .then(response => response.json())
                .then(data => {
                    canciones = data;
                    const filteredSongs = canciones.filter(cancion => {
                        const matchesAlbum = cancion.album_name.toLowerCase() === item.album_name.toLowerCase();
                        const isNotCurrentSong = cancion.song_name.toLowerCase() !== item.song_name.toLowerCase();

                        return matchesAlbum && isNotCurrentSong;
                    });
                    mostarCanciones(filteredSongs);
                })
        }

        function mostarCanciones(songs){
            const contenedor = document.getElementById('song-list');
            contenedor.innerHTML = '';
            songs.forEach(cancion => {
                const songDiv = document.createElement('div');
                songDiv.className = 'songDiv';
                const li = document.createElement('p');
                li.className = 'linfo';
                li.textContent = cancion.song_name;
                li.addEventListener('click', () => {
                    localStorage.setItem('item', JSON.stringify(cancion));
                    window.location.href = `../music_detail/`;
                });
                songDiv.appendChild(li);
                contenedor.appendChild(songDiv);
            });
        }

        document.getElementById('Descripcion').addEventListener('click', function() {
            const Desc = document.getElementById('Desc');
            Desc.style.display = Desc.style.display === 'block' ? 'none' : 'block';
        });

        function mostrarComentarios() {
    const comentariosDiv = document.getElementById('comentarios');
    comentariosDiv.innerHTML = '';

    item.comments.forEach((comment, index) => {
        const commentDiv = document.createElement('div');
        commentDiv.classList.add('comment');

        const userDiv = document.createElement('div');
        userDiv.classList.add('user');

        const img = document.createElement('img');
        img.src = comment.profile_photo;
        img.alt = "Foto de perfil";
        img.onerror = function() {
            img.src = "../static/Photos/OIP.jpg";
        };
        userDiv.appendChild(img);

        const userName = document.createElement('p');
        userName.textContent = `${comment.user_name}`;
        userDiv.appendChild(userName);

        const commentContentDiv = document.createElement('div');
        commentContentDiv.classList.add('come');

        const userComment = document.createElement('p');
        userComment.textContent = `Comentario: ${comment.comment}`;
        commentContentDiv.appendChild(userComment);

        const userRating = document.createElement('div');
        userRating.classList.add('rating');
        for (let i = 1; i <= 5; i++) {
            const star = document.createElement('span');
            star.classList.add('star');
            star.innerHTML = i <= comment.rating ? '★' : '☆';
            userRating.appendChild(star);
        }
        commentContentDiv.appendChild(userRating);

        commentDiv.appendChild(userDiv);
        commentDiv.appendChild(commentContentDiv);
        comentariosDiv.appendChild(commentDiv);
    });
}

        function addComment() {
            const newComment = document.getElementById('new-comment').value;
            const userName = "Nuevo Usuario";
            const profilePhoto = "../static/Photos/Users/default.jpg";
            const rating = document.querySelector('.star-rating input:checked') ? document.querySelector('.star-rating input:checked').value : 0;

            if (newComment) {
                const comment = {
                    user_name: userName,
                    profile_photo: profilePhoto,
                    comment: newComment,
                    rating: rating
                };

                item.comments.unshift(comment);
                mostrarComentarios();

                document.getElementById('new-comment').value = '';
                document.querySelector('.star-rating input:checked').checked = false;
            } else {
                alert('Por favor, añade un comentario.');
            }
            hideInfoBoxC();
        }

    </script>
{% endblock %}